include:
  - local: /ci-cd/ci-templates/.base-images-builder-template.yml
  - local: /ci-cd/ci-templates/.scripted-api-atoms-builder-template.yml
  - local: /ci-cd/ci-templates/.scripted-simple-atoms-builder-template.yml
  - local: /ci-cd/ci-templates/.scripted-task-atoms-builder-template.yml
  - local: /ci-cd/ci-templates/.git-sync-template.yml

stages:
  - pre-flight
  - git-tagger
  - build-bases
  - build-arm-bases
  - build-scripted-simple-atoms
  - build-scripted-api-atoms
  - build-scripted-task-atoms
  - git-sync
  - post-flight

before_script:
  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  - echo "$DOCKER_REGISTRY_TOKEN" | docker login -u "$DOCKER_REGISTRY_USER" --password-stdin

variables:
  BUILD_FOR_PRIVATE_REGISTRY: "true"
  MIRROR: "false"

clean-images:
  tags:
    - piximos
  stage:
    post-flight
  script:
    - ./ci-cd/scripts/clean-image.sh
  dependencies:
    - build-saa-base
    - build-sta-base
    - build-sta-s3-file-sync
    - build-sta-uptime-tracker
    - build-saa-qr-code-s3
    - build-saa-qr-code-fs
    - build-saa-otp-maker
    - build-saa-s3-unzipper

validate-branch-name:
  tags:
    - piximos
  allow_failure: false
  stage:
    pre-flight
  script:
    - ./ci-cd/scripts/validate-commit.sh

deployment-slacker:
  tags:
    - piximos
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^(master)|((minor|major)\-release)$/
      variables:
        SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL}
  stage:
    post-flight
  script:
    - ./ci-cd/scripts/pipeline-slacker.sh
